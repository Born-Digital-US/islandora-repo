# Uninstall this config when the feature is uninstalled
dependencies:
  enforced:
    module:
      - migrate_islandora_csv

id: etd_node
label: Import ETD Nodes from CSV
migration_group: migrate_etd_csv

source:
  plugin: csv
  path: modules/custom/migrate_islandora_csv/data/etd_migration.csv

  # 1 means you have a header row, 0 means you don't
  header_row_count: 1

  # Each migration needs a unique key per row in the csv.  Here we're using the file path.
  keys:
    - Item ID

  # You can't enter string literals into a process plugin, but you can give it a constant as a 'source'.
  constants:
    # We're tagging our nodes as Images
    model: Digital Document

    # Everything gets created as admin
    uid: 1
    cid: 'Electronic Thesis and Dissertations'
    pres_state: '31'
    handle: "https://hdl.handle.net/2286/R.I."
    in_copyright_tid: '35'
    rights_tid: '68'

# Subjects,Personal Contributors,Institutional Contributors,Language,Identifiers,Series,Resource Types,Citation,Notes,Visibility,Embargo Date
# created:
# field_linked_agent: (typed_relation)
# field_edtf_date_created:
# field_display_hints: (taxo)
# field_language: (taxo)
# field_resource_type: (taxo)
# Embargo - will this go on the media?
# Actual files
# public/private status
# download status on deriv media
# download status on master/original media
# Set fields using values from the CSV
process:
  field_extent:
    plugin: skip_on_empty
    source: Extent
    method: process

  field_edtf_date_created:
    plugin: skip_on_empty
    source: Date Created
    method: process

  # Make the object an 'Digital Document'
  field_model:
    plugin: entity_lookup
    source: constants/model
    entity_type: taxonomy_term
    value_key: name
    bundle_key: vid
    bundle: islandora_models

  field_description:
    plugin: skip_on_empty
    source: Description
    method: process

  field_copyright_date:
    plugin: skip_on_empty
    source: Date Created
    method: process

  field_title/target_id:
    -
      plugin: migration
      migration: etd_complex_titles
      no_stub: true
      source: Item ID
    -
      plugin: extract
      index:
        - '0'
  field_title/target_revision_id:
    -
      plugin: migration
      migration: etd_complex_titles
      no_stub: true
      source: Item ID
    -
      plugin: extract
      index:
        - 1

  title: Item Title
  uid: constants/uid
  field_pid: Item ID

  field_preservation_state:
    plugin: entity_lookup
    source: constants/pres_state
    entity_type: taxonomy_term
    bundle_key: vid
    value_key: tid
    bundle: preservation_states

  field_handle:
    plugin: concat
    source:
      - constants/handle
      - Item ID

  # field_note_para:
  #   plugin: iterator
  #   source: Item ID
  #   process:
  #     temp_ids:
  #       plugin: migration_lookup
  #       migration: etd_notes
  #       source: Notes
  #     target_id:
  #       plugin: extract
  #       source: '@temp_ids'
  #       index:
  #         - 0
  #     target_revision_id:
  #       plugin: extract
  #       source: '@temp_ids'
  #       index:
  #         - 1


  field_copyright_statement:
    plugin: entity_lookup
    source: constants/in_copyright_tid
    entity_type: taxonomy_term
    bundle_key: vid
    value_key: tid
    bundle: copyright_statements

  field_reuse_permissions:
    -
      plugin: skip_on_empty
      method: process
      source: Reuse
    -
      plugin: entity_lookup
      source: constants/rights_tid
      entity_type: taxonomy_term
      bundle_key: vid
      value_key: tid
      bundle: reuse_permissions

  field_member_of:
    source: constants/cid
    plugin: entity_lookup
    entity_type: node
    access_check: 0
    bundle_key: type
    bundle: collection
    value_key: title


# We're making nodes
destination:
  plugin: 'entity:node'
  default_bundle: asu_repository_item
migration_dependencies:
  optional:
    - etd_complex_titles
    # - etd_notes
