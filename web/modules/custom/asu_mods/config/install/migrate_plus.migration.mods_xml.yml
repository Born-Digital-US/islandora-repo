dependencies:
  enforced:
    module:
      - asu_mods
id: mods_xml
label: Import/Update Nodes from MODS XML
migration_group: mods_xml

source:
  plugin: url
  data_fetcher_plugin: file
  data_parser_plugin: xml
  urls: /var/www/html/drupal/web/modules/custom/asu_mods/data/t2mods.xml
  namespaces:
    xlink: "http://www.w3.org/1999/xlink"
  item_selector: /modsCollection/mods
  fields:
    -
      name: main_title
      label: title
      selector: titleInfo/title
    -
      name: nonsort
      label: nonsort
      selector: titleInfo/nonSort
    -
      name: subtitle
      label: subtitle
      selector: titleInfo/subTitle
    -
      name: pid
      label: pid
      selector: 'recordInfo/recordIdentifier[@src="aztes"]'
    -
      name: abstract
      label: abstract
      selector: 'abstract'
    -
      name: extent
      label: extent
      selector: 'physicalDescription/extent'
    -
      name: date_created
      label: date created
      selector: 'originInfo/dateCreated'
    -
      name: collection_handle
      label: collection
      selector: 'relatedItem[@type="host"]/@xlink:href'
    -
      name: genre_labels
      label: genre labels
      selector: 'genre[@valueURI]'
    -
      name: genre_uris
      label: genre_uris
      selector: 'genre/@valueURI'
    -
      name: genre_wo_uris
      label: genre without uris
      selector: 'genre[not(@valueURI)]'
  ids:
    pid:
      type: string
  constants:
    uid: 1
    description_format: description_restricted_items
    model: Digital Document


process:
  # setting the nid allows you to update nodes which were not originally created by this migration - if we skip_on_empty it should create new nodes
  nid:
    plugin: skip_on_empty
    method: process
    source: pid
  title_temp:
    -
      plugin: concat
      source:
        - nonsort
        - main_title
      delimiter: ' '
  field_title:
    - plugin: concat
      source:
        - '@title_temp'
        - subtitle
      delimiter: ': '
    -
      plugin: paragraph_title_generate
      paragraph_type: 'complex_title'
      split_into_parts: true
      fields:
        field_nonsort: " "
        field_main_title: " "
        field_subtitle: " "
  title:
    - plugin: concat
      source:
        - '@title_temp'
        - subtitle
      delimiter: ': '
  field_rich_description/value:
    plugin: skip_on_empty
    method: process
    source: abstract
  field_rich_description/format: constants/description_format
  field_extent:
    plugin: skip_on_empty
    source: extent
    method: process
  field_edtf_date_created:
    plugin: skip_on_empty
    source: date_created
    method: process
  # field_table_of_contents
  # field_language
  # field_linked_agent
  # field_note_para
  # field_preferred_citation
  # field_statement_responsibility
  # field_typed_identifier
  # field_handle
  # field_peer_reviewed
  # field_open_access
  # field_genre
  # status - set not from default
  # created
  # uid - with callback for asurite -> id
  # field_copyright_statement
  # field_reuse_permissions
  # field_member_of
  # field_additional_memberships
  # field_edtf_copyright_date

  uid: constants/uid
  status:
    plugin: default_value
    default_value: 1
  type:
    plugin: default_value
    default_value: asu_repository_item
  field_model:
    source: constants/model
    plugin: entity_lookup
    entity_type: taxonomy_term
    value_key: name
    bundle_key: vid
    bundle: islandora_models
  field_member_of:
    plugin: multi_entity_lookup
    source:
      - collection_handle
    lookup_field: field_handle
    entity_type: node
    access_check: 0
    bundle_key: type
    bundle: collection
  genres:
    plugin: make_array_groups
    source:
      - genre_labels
      - genre_uris
    keys:
      - name
      - uri
  genres_without_uris:
    plugin: make_array_groups
    source:
      - genre_wo_uris
    keys:
      - name
  all_the_genres:
    plugin: merge_skip_empty
    source:
      - '@genres_without_uris'
      - '@genres'
  field_genre:
    plugin: name_uri_generate
    uri_field: field_authority_link
    default_vocabulary: genre
    name_array_key: name
    uri_array_key: uri
    source: '@all_the_genres'

destination:
  plugin: 'entity:node'
  default_bundle: asu_repository_item
  # list all fields we want to overwrite
  overwrite_properties:
    - field_title
    - field_rich_description
    - field_rich_description/value
    - field_rich_description/format
    - field_extent
    - field_edtf_date_created
    - field_table_of_contents
    - field_language
    - field_linked_agent
    - field_note_para
    - field_preferred_citation
    - field_statement_responsibility
    - field_typed_identifier
    - field_handle
    - field_peer_reviewed
    - field_open_access
    - field_genre
    - status
    # - created
    - uid
    - field_copyright_statement
    - field_reuse_permissions
    - field_member_of
    - field_additional_memberships
    - field_edtf_copyright_date

