dependencies:
  enforced:
    module:
      - asu_mods
id: mods_xml
label: Import/Update Nodes from MODS XML
migration_group: mods_xml

# everything that goes in field_linked_agent will be a name top level element.
# they will contain a type attribute which maps to the bundle of the taxonomy term
# (ie. person). those names will also contain the roleTerm element for the role.
# the name itself will be in the namePart sub-element of the name . Names may or
# may not have URIs
#
# For subjects, all subjects will be in subject top level elements, but depending
# on what type of subject will determine what's inside that element.
#    field_geographic_subject have geographic sub-elements to the subject element
#    field_temporal_subject have temporal sub-elements
#    field_subject have topic sub-elements
#    field_subjects_name have name sub-elements
#    field_title_subject have title/titleInfo sub-elements
# All of the subjects have the potential to have uris, but may not
# ----------------------------------------------------------------------------
source:
  plugin: url
  data_fetcher_plugin: file
  data_parser_plugin: xml
  urls: /var/www/html/drupal/web/modules/custom/asu_mods/data/t2mods.xml
  namespaces:
    xlink: "http://www.w3.org/1999/xlink"
  item_selector: /modsCollection/mods
  fields:
    -
      name: main_title
      label: title
      selector: titleInfo/title
    -
      name: nonsort
      label: nonsort
      selector: titleInfo/nonSort
    -
      name: subtitle
      label: subtitle
      selector: titleInfo/subTitle
    -
      name: pid
      label: pid
      selector: 'recordInfo/recordIdentifier[@src="aztes"]'
    -
      name: abstract
      label: abstract
      selector: 'abstract'
    -
      name: extent
      label: extent
      selector: 'physicalDescription/extent'
    -
      name: date_created
      label: date created
      selector: 'originInfo/dateCreated'
    -
      name: collection_handle
      label: collection
      selector: 'relatedItem[@type="host"]/@xlink:href'
    -
      name: handle
      label: handle
      selector: 'identifier[@type="hdl"]'
    -
      name: genre_labels
      label: genre labels
      selector: 'genre[@valueURI]'
    -
      name: genre_uris
      label: genre_uris
      selector: 'genre/@valueURI'
    -
      name: genre_wo_uris
      label: genre without uris
      selector: 'genre[not(@valueURI)]'
    -
      name: note
      label: note
      selector: 'note[not(@*)]'
    -
      name: pref_citation
      label: preferred citation
      selector: 'note[@type="preferred citation"]'
    -
      name: reuse_permissions
      label: reuse permission
      selector: 'accessCondition[@type="use and reproduction" and not(text()="In Copyright" or text()="No Copyright - United States" or text()="No Known Copyright")]'
    -
      name: copyright
      label: copyright
      selector: 'accessCondition[@type="use and reproduction" and (text()="In Copyright" or text()="No Copyright - United States" or text()="No Known Copyright")]'
    -
      name: edtf_created_date
      label: edtf date
      selector: 'originInfo/dateCreated'
    -
      name: visibility
      label: record visibility
      selector: 'recordInfo/recordInfoNote[@type="visibility"]'
    -
      name: agent_person_name
      label: agents (person) name
      selector: 'name[@type="person" and @valueUri and roleTerm[@type="code"]]/namePart'
    -
      name: agent_person_uris
      label: agents (person) name uri
      selector: 'name[@type="person" and @valueUri and roleTerm[@type="code"]]/@valueUri'
    -
      name: agent_person_code
      label: agent (person) role code
      selector: 'name[@type="person" and not(@valueUri)]/roleTerm[@type="code"]'
    -
      name: agent_person_name_wo_uris
      label: agents (person, without uri) name
      selector: 'name[@type="person" and not(@valueUri) and roleTerm[@type="code"]]/namePart'
    -
      name: agent_person_code_wo_uris
      label: agent (person, without uri) role code
      selector: 'name[@type="person" and not(@valueUri)]/roleTerm[@type="code"]'      
  ids:
    pid:
      type: string
  constants:
    uid: 1
    description_format: description_restricted_items
    model: Digital Document


process:
  # setting the nid allows you to update nodes which were not originally created by this migration - if we skip_on_empty it should create new nodes
  nid:
    plugin: skip_on_empty
    method: process
    source: pid
  title_temp:
    -
      plugin: concat
      source:
        - nonsort
        - main_title
      delimiter: ' '
  field_title:
    - plugin: concat
      source:
        - '@title_temp'
        - subtitle
      delimiter: ': '
    -
      plugin: paragraph_title_generate
      paragraph_type: 'complex_title'
      split_into_parts: true
      fields:
        field_nonsort: " "
        field_main_title: " "
        field_subtitle: " "
  title:
    - plugin: concat
      source:
        - '@title_temp'
        - subtitle
      delimiter: ': '
  field_rich_description/value:
    plugin: skip_on_empty
    method: process
    source: abstract
  field_rich_description/format: constants/description_format
  field_extent:
    plugin: skip_on_empty
    source: extent
    method: process
  field_edtf_date_created:
    plugin: skip_on_empty
    source: date_created
    method: process
  # field_table_of_contents
  # field_language
  # field_linked_agent
  # ✓ field_note_para
  # ✓ field_preferred_citation
  # ✓ field_statement_responsibility
  # field_typed_identifier
  # ✓ field_handle
  # field_peer_reviewed
  # field_open_access
  # ✓ field_genre
  # ✓ status - set not from default
  # ✓ moderation_state
  # created
  # uid - with callback for asurite -> id
  # ✓ field_copyright_statement
  # ✓ field_reuse_permissions
  # ✓ field_member_of
  # field_additional_memberships
  # ✓ field_edtf_copyright_date

  uid: constants/uid
  status:
    plugin: default_value
    default_value: 1
  moderation_state:
    plugin: static_map
    source: visibility
    map:
      Private: draft
      Public: published
      1.0: published
      1: published
      0: draft
      0.0: draft
    default_value: published
  type:
    plugin: default_value
    default_value: asu_repository_item
  field_model:
    source: constants/model
    plugin: entity_lookup
    entity_type: taxonomy_term
    value_key: name
    bundle_key: vid
    bundle: islandora_models
  field_member_of:
    plugin: multi_entity_lookup
    source:
      - collection_handle
    lookup_field: field_handle
    entity_type: node
    access_check: 0
    bundle_key: type
    bundle: collection
  field_handle:
    plugin: skip_on_empty
    method: process
    source: handle
  genres:
    plugin: make_array_groups
    source:
      - genre_labels
      - genre_uris
    keys:
      - name
      - uri
  genres_without_uris:
    plugin: make_array_groups
    source:
      - genre_wo_uris
    keys:
      - name
  all_the_genres:
    plugin: merge_skip_empty
    source:
      - '@genres_without_uris'
      - '@genres'
  field_genre:
    plugin: name_uri_generate
    uri_field: field_authority_link
    default_vocabulary: genre
    name_array_key: name
    uri_array_key: uri
    source: '@all_the_genres'
  field_note_para:
    -
      plugin: skip_on_empty
      source: note
      method: process
    -
      plugin: callback
      callable: trim
    -
      plugin: paragraph_generate
      paragraph_type: 'complex_note'
      delimiter: '|'
      fields:
        field_note_text:
          order: 0
          type: text
  field_preferred_citation/value:
    plugin: skip_on_empty
    method: process
    source: pref_citation
  field_preferred_citation/format: constants/description_format
  field_statement_responsibility:
    -
      plugin: skip_on_empty
      source: note
      method: process
    -
      plugin: callback
      callable: trim
  field_reuse_permissions:
    -
      plugin: skip_on_empty
      source: reuse_permissions
      method: process
    -
      plugin: entity_lookup
      entity_type: taxonomy_term
      value_key: name
      bundle_key: vid
      bundle: reuse_permissions
  field_copyright_statement:
    -
      plugin: skip_on_empty
      source: copyright
      method: process
    -
      plugin: entity_lookup
      entity_type: taxonomy_term
      value_key: name
      bundle_key: vid
      bundle: copyright_statements
  field_edtf_date_created:
    plugin: skip_on_empty
    method: process
    source: edtf_created_date
  agents:
    plugin: make_array_groups
    source:
      - agent_person_name
      - agent_person_uris
    keys:
      - name
      - uri
  agents_without_uris:
    plugin: make_array_groups
    source:
      - agent_person_name_wo_uris
    keys:
      - name
  all_the_agents:
    plugin: merge_skip_empty
    source:
      - '@agents_without_uris'
      - '@agents'
  field_linked_agents:
    -
      plugin: typed_relation_generate
      uri_field: field_authority_link
      default_vocabulary: Person
      name_array_key: name
      uri_array_key: uri
      source: '@all_the_agents'
destination:
  plugin: 'entity:node'
  default_bundle: asu_repository_item
  # list all fields we want to overwrite
  overwrite_properties:
    - field_title
    - field_rich_description
    - field_rich_description/value
    - field_rich_description/format
    - field_extent
    - field_edtf_date_created
    - field_table_of_contents
    - field_language
    - field_linked_agent
    - field_note_para
    - field_preferred_citation
    - field_statement_responsibility
    - field_typed_identifier
    - field_handle
    - field_peer_reviewed
    - field_open_access
    - field_genre
    - status
    # - created
    - uid
    - field_copyright_statement
    - field_reuse_permissions
    - field_member_of
    - field_additional_memberships
    - field_edtf_copyright_date

