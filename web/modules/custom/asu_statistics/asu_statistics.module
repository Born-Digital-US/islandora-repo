<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\node\Entity\NodeType;

/**
 * @file
 * Contains asu_statistics.module.
 */

// asu_statistics


/**
 * Implements hook_theme().
 */
function asu_statistics_theme($existing, $type, $theme, $path) {
  return [
    'asu_statistics_chart' => [
      'variables' => ['form' => NULL, 'show_csv_link' => NULL, 'stats' => NULL],
    ],
    'islandora_repository_reports_tips_block' => [
      'variables' => ['content' => NULL],
    ],
  ];
}

/**
 * Default preprocessor for the islandora_repository_reports_theme hook.
 */
function template_preprocess_asu_statistics_tips_block(&$variables) {
  $variables['attributes'] = [
    'id' => ['islandora_repository_reports_tips_content'],
  ];
}

/**
 * Default preprocessor for the asu_statistics_theme hook.
 */
function template_preprocess_asu_statistics_chart(&$variables) {
  $utilities = \Drupal::service('islandora_repository_reports.utilities');
  $variables['attributes'] = [
    'id' => ['asu_statistics_chart'],
  ];

  if (!empty(\Drupal::hasService('asu_statistics.datasource.published_nodes_by_month'))) {
    $data_source = \Drupal::service('asu_statistics.datasource.published_nodes_by_month');
  }
  else {
    \Drupal::messenger()->addMessage(t('The report type you last selected is no longer available. Choose another report type, or contact the site administrator.'), 'warning');
    return;
  }

  // Since the report is generate by calling $utilities->getReportData(),
  // we need a way to avoid calling that method when a user simply views
  // the report page. Tempstore age seems as good as any.
//  if ($utilities->tempstoreIsStale()) {
//    return;
//  }

  if ($data_source->getChartType() == 'html') {
    $variables['html_content'] = $data_source->getData();
    $variables['chart_title'] = $data_source->getChartTitle('');
  }

  if ($variables['show_csv_link']) {
    $default_schema = \Drupal::config('system.file')->get('default_scheme');
    $files_path = \Drupal::service('file_system')->realpath(default_schema . "://");
    $filename = 'asu_statistics_' . $report_type . '.csv';
    $report_url = file_create_url($default_schema . '://' . $filename);
    $variables['csv_url'] = $report_url;
    // chart_type is 'pie', 'bar', etc from Chart.js, or 'html' for rendered
    // HTML content such as a table or list.
    $variables['chart_type'] = $data_source->getChartType();
  }
}

/**
 * Implements hook_form_form_id_alter().
 */
function asu_statistics_form_asu_statistics_report_selector_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['#attached']['library'][] = 'asu_statistics/asu_statistics_loading_message';
  $utilities = \Drupal::service('islandora_repository_reports.utilities');

  // Content type select widget.
  $selected_content_types = $utilities->getFormElementDefault('islandora_repository_reports_content_types', []);

  // Determine whether to show the content type list in the
  // report selector form.
  $data_sources = ['published_nodes_by_month']; // $utilities->getServices(TRUE);
  $need_content_type_list = [];
  $do_not_need_content_type_list = ['content_type'];
  foreach ($data_sources as $report_type) {
    $data_source_service_id = 'asu_statistics.datasource.' . $report_type;
    $data_source = \Drupal::service($data_source_service_id);
    if ($data_source->getBaseEntity() == 'node' && !in_array($report_type, $do_not_need_content_type_list)) {
      $need_content_type_list[] = ['value' => $report_type];
    }
  }

  $content_types = NodeType::loadMultiple();
  $content_type_options = [];
  foreach ($content_types as $key => $value) {
    $content_type_options[$key] = $value->label();
  }
  $form['islandora_repository_reports_content_types'] = [
    '#type' => 'checkboxes',
    '#weight' => 0,
    '#title' => t('Content types to include in report'),
    '#options' => $content_type_options,
    '#default_value' => $selected_content_types,
    '#states' => [
      'visible' => [
        ':input[name="islandora_repository_reports_report_type"]' => [
          $need_content_type_list,
        ],
      ],
    ],
  ];

  // Date range widgets for some reports.
  $start_of_range = $utilities->getFormElementDefault('islandora_repository_reports_nodes_by_month_range_start', '');
  $end_of_range = $utilities->getFormElementDefault('islandora_repository_reports_nodes_by_month_range_end', '');

  $form['islandora_repository_reports_nodes_by_month_range_start'] = [
    '#type' => 'textfield',
    '#weight' => 0,
    '#size' => 10,
    '#title' => t('Start date'),
    '#default_value' => $start_of_range,
    '#placeholder' => 'yyyy-mm',
    '#description' => t('Limit report to nodes created in or after the specified month. Leave empty to include all months up to end date.'),
    '#states' => [
      'visible' => [
        ':input[name="islandora_repository_reports_report_type"]' => [
          ['value' => 'published_nodes_by_month'],
          ['value' => 'genre'],
          ['value' => 'vocab'],
        ],
      ],
    ],
  ];

  $form['islandora_repository_reports_nodes_by_month_range_end'] = [
    '#type' => 'textfield',
    '#weight' => 0,
    '#size' => 10,
    '#title' => t('End date'),
    '#placeholder' => 'yyyy-mm',
    '#default_value' => $end_of_range,
    '#description' => t('Limit report to nodes created up to and including the specified month. Leave empty to include all months after start date.'),
    '#states' => [
      'visible' => [
        ':input[name="islandora_repository_reports_report_type"]' => [
          ['value' => 'published_nodes_by_month'],
          ['value' => 'genre'],
          ['value' => 'vocab'],
        ],
      ],
    ],
  ];
}

/**
 * Implements hook_page_attachments().
 */
function asu_statistics_page_attachments(array &$attachments) {
  $attachments['#attached']['library'][] = 'asu_statistics/asu_statistics_css';
  $utilities = \Drupal::service('islandora_repository_reports.utilities');
  $current_path = \Drupal::service('path.current')->getPath();
  if ($current_path == '/admin/reports/asu_statistics') {
    $report_type = 'published_nodes_by_month'; // $utilities->getFormElementDefault('islandora_repository_reports_report_type', 'mimetype');

    // Since the report is generate by calling $utilities->getReportData(),
    // we need a way to avoid calling that method when a user simply views
    // the report page. Tempstore age seems as good as any.
    //
    // If this is cached, the chart does not get added. Commenting out this logic.
    //    if ($utilities->tempstoreIsStale()) {
    //      return;
    //    }

    if (!empty(\Drupal::hasService('asu_statistics.datasource.published_nodes_by_month'))) {
      $data_source = \Drupal::service('asu_statistics.datasource.published_nodes_by_month');
    }
    else {
      \Drupal::messenger()->addMessage(t('The report type you last selected is no longer available. Choose another report type, or contact the site administrator.'), 'warning');
      return;
    }
  }
}

/**
 * Implements hook_file_download().
 */
function asu_statistics_file_download($uri) {
  if (preg_match('/asu_statistics_/', $uri)) {
    if (\Drupal::currentUser()->hasPermission('view islandora repository reports')) {
      return ['Content-disposition' => 'attachment; filename="' . basename($uri) . '"'];
    }
    else {
      return -1;
    }
  }
  return NULL;
}
