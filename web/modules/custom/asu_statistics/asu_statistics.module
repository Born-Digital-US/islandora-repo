<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\node\Entity\NodeType;

/**
 * @file
 * Contains asu_statistics.module.
 */

// asu_statistics


/**
 * Implements hook_theme().
 */
function asu_statistics_theme($existing, $type, $theme, $path) {
  return [
    'asu_statistics_chart' => [
      'variables' => ['form' => NULL, 'show_csv_link' => NULL, 'stats' => NULL,
        'stats_table' => NULL],
    ],
    'islandora_repository_reports_tips_block' => [
      'variables' => ['content' => NULL],
    ],
  ];
}

/**
 * Default preprocessor for the islandora_repository_reports_theme hook.
 */
function template_preprocess_asu_statistics_tips_block(&$variables) {
  $variables['attributes'] = [
    'id' => ['islandora_repository_reports_tips_content'],
  ];
}

/**
 * Default preprocessor for the asu_statistics_theme hook.
 */
function template_preprocess_asu_statistics_chart(&$variables) {
  $utilities = \Drupal::service('asu_statistics.utilities');
  $variables['attributes'] = [
    'id' => ['asu_statistics_chart'],
  ];

  if (!empty(\Drupal::hasService('asu_statistics.datasource.published_nodes_by_month'))) {
    $data_source = \Drupal::service('asu_statistics.datasource.published_nodes_by_month');
  }
  else {
    \Drupal::messenger()->addMessage(t('The report type you last selected is no longer available. Choose another report type, or contact the site administrator.'), 'warning');
    return;
  }

  // Since the report is generate by calling $utilities->getReportData(),
  // we need a way to avoid calling that method when a user simply views
  // the report page. Tempstore age seems as good as any.
//  if ($utilities->tempstoreIsStale()) {
//    return;
//  }

  if ($data_source->getChartType() == 'html') {
    $variables['html_content'] = $data_source->getData();
    $variables['chart_title'] = $data_source->getChartTitle('');
  }

  if ($variables['show_csv_link']) {
    $default_schema = \Drupal::config('system.file')->get('default_scheme');
    $files_path = \Drupal::service('file_system')->realpath(default_schema . "://");
    $report_type = 'published_nodes_by_month';
    $filename = 'asu_statistics_' . $report_type . '.csv';
    $report_url = file_create_url($default_schema . '://' . $filename);
    $variables['csv_url'] = $report_url;
    // chart_type is 'pie', 'bar', etc from Chart.js, or 'html' for rendered
    // HTML content such as a table or list.
    $variables['chart_type'] = $data_source->getChartType();
  }
}

/**
 * Implements hook_form_form_id_alter().
 */
function asu_statistics_form_asu_statistics_report_selector_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['#attached']['library'][] = 'asu_statistics/asu_statistics_loading_message';
  $utilities = \Drupal::service('asu_statistics.utilities');

  // Determine whether to show the content type list in the
  // report selector form.
  $data_sources = ['published_nodes_by_month']; // $utilities->getServices(TRUE);
  $need_content_type_list = [];
  $do_not_need_content_type_list = ['content_type'];
  foreach ($data_sources as $report_type) {
    $data_source_service_id = 'asu_statistics.datasource.' . $report_type;
    $data_source = \Drupal::service($data_source_service_id);
    if ($data_source->getBaseEntity() == 'node' && !in_array($report_type, $do_not_need_content_type_list)) {
      $need_content_type_list[] = ['value' => $report_type];
    }
  }
}

/**
 * Implements hook_page_attachments().
 */
function asu_statistics_page_attachments(array &$attachments) {
  $attachments['#attached']['library'][] = 'asu_statistics/asu_statistics_css';
  $asu_utilities = \Drupal::service('asu_statistics.utilities');
  $current_path = \Drupal::service('path.current')->getPath();
  if ($current_path == '/admin/reports/asu_statistics') {
    $report_type = 'published_nodes_by_month'; // $utilities->getFormElementDefault('islandora_repository_reports_report_type', 'mimetype');

    // Since the report is generate by calling $utilities->getReportData(),
    // we need a way to avoid calling that method when a user simply views
    // the report page. Tempstore age seems as good as any.
    //
    // If this is cached, the chart does not get added. Commenting out this logic.
    //    if ($utilities->tempstoreIsStale()) {
    //      return;
    //    }

    if (!empty(\Drupal::hasService('asu_statistics.datasource.published_nodes_by_month'))) {
      $data_source = \Drupal::service('asu_statistics.datasource.published_nodes_by_month');
      $chart_type = $data_source->getChartType();
      if ($chart_type == 'pie') {
        $config = \Drupal::config('islandora_repository_reports.settings');
        $food_chart_type = $config->get('islandora_repository_reports_pie_or_doughnut');
        $pie_chart_data = $asu_utilities->getReportData($report_type);
        $attachments['#attached']['library'][] = 'asu_statistics/asu_statistics_chart';
        $attachments['#attached']['drupalSettings']['islandora_repository_reports']['chart_type'] = $food_chart_type;
        $attachments['#attached']['drupalSettings']['islandora_repository_reports']['chart_title'] = $pie_chart_data['title'];
        $attachments['#attached']['drupalSettings']['islandora_repository_reports']['chart_data'] = $pie_chart_data;
      }
      if ($chart_type == 'bar') {
        $bar_chart_data = $asu_utilities->getReportData($report_type);
        $attachments['#attached']['library'][] = 'asu_statistics/asu_statistics_chart';
        $attachments['#attached']['drupalSettings']['islandora_repository_reports']['chart_type'] = 'bar';
        $attachments['#attached']['drupalSettings']['islandora_repository_reports']['chart_title'] = $bar_chart_data['title'];
        $attachments['#attached']['drupalSettings']['islandora_repository_reports']['chart_data'] = $bar_chart_data;
      }
    }
    else {
      \Drupal::messenger()->addMessage(t('The report type you last selected is no longer available. Choose another report type, or contact the site administrator.'), 'warning');
      return;
    }
  }
}

/**
 * Implements hook_file_download().
 */
function asu_statistics_file_download($uri) {
  if (preg_match('/asu_statistics_/', $uri)) {
    if (\Drupal::currentUser()->hasPermission('view islandora repository reports')) {
      return ['Content-disposition' => 'attachment; filename="' . basename($uri) . '"'];
    }
    else {
      return -1;
    }
  }
  return NULL;
}

function asu_statistics_make_table_rows_from_result($result) {
  $build_output = $rows = [];
  $month_names = [];
  for ($month = 1; $month < 13; $month++) {
    $month_names[$month] = date("F", mktime(0, 0, 0, $month, 10));
  }
  // get all of the rows into an array where each row contains the results for
  // the query result which have records with these years / months.
  $earliest_year = PHP_INT_MAX;
  $latest_year = 0;
  foreach ($result as $child_obj) {
    if ($child_obj->item_year < $earliest_year) {
      $earliest_year = $child_obj->item_year;
    }
    if ($child_obj->item_year > $latest_year) {
      $latest_year = $child_obj->item_year;
    }
    $record_arr = (array)$child_obj;
    $record_arr['created'] = mktime(0, 0, 0, $child_obj->item_month, 10);
    $record_arr['item_month_name'] = $month_names[$child_obj->item_month];
    $pad0_month = (($child_obj->item_month < 10) ? "0" : "") . $child_obj->item_month;
    $rows[$child_obj->item_year . "-" . $pad0_month] = $record_arr;
  }

  // fill any empty months with a 0.
  for ($year = $earliest_year; $year <= $latest_year; $year++) {
    $build_output[$year]['Year'] = $year;
    for ($month = 1; $month < 13; $month++) {
      $pad0_month = (($month < 10) ? "0" : "") . $month;
      $year_month_key = $year . "-" . $pad0_month;
      $month_key = substr($month_names[$month], 0, 3);
      if (!array_key_exists($year_month_key, $rows)) {
        $build_output[$year][$month_key] = 0;
      } else {
        $build_output[$year][$month_key] = $rows[$year_month_key]['items'];
      }
    }
  }
  // now, add a row total at the end.
  foreach ($build_output as $year => $month_data) {
    $row_total = 0;
    $skip_first_cell = TRUE;
    foreach ($month_data as $month_num => $items) {
      $row_total+= ($skip_first_cell) ? 0 : $items;
      $skip_first_cell = FALSE;
    }
    $build_output[$year]['total'] = $row_total;
  }
  return $build_output;
}

function asu_statistics_get_stats($collection_node_id = NULL) {
  $query = \Drupal::database()->select('node_field_data', 'node_field_data');
  $query->addExpression('COUNT(node_field_data.nid)', 'items');
  $query->addExpression('YEAR(FROM_UNIXTIME(node_field_data.created))', 'item_year');
  $query->addExpression('MONTH(FROM_UNIXTIME(node_field_data.created))', 'item_month');
    if ($collection_node_id) {
    $query->join('node__field_member_of', 'node__field_member_of',
        'node__field_member_of.entity_id = node_field_data.nid');
    $query->condition('node__field_member_of.field_member_of_target_id', $collection_node_id);
  }
  // Do not limit the results by published nodes only -- the make_table_rows_from_result
  // will need to inspect the item's moderation state by using
  //     $asu_utils = \Drupal::service('asu_utils');
  //     $node = \Drupal::entityTypeManager()->getStorage('node')->load($node);
  //     $node_is_published = $asu_utils->c($node);

  // $query->condition('node_field_data.status', 1);
  $query->groupBy('YEAR(FROM_UNIXTIME(node_field_data.created)), MONTH(FROM_UNIXTIME(node_field_data.created))');
  $result = $query->execute()->fetchAll();
  return asu_statistics_make_table_rows_from_result($result);
}

/**
 * Implements hook_preprocess_HOOK().
 */
function asu_statistics_node_view(array &$build, $entity, $display, $view_mode) {
  if ($entity->getType() == 'store') {
    $title = $build['title'][0]['#context']['value'];
    $new_title = t('@title Review', ['@title' => $title]);
    $build['title'][0]['#context']['value'] = $new_title;
  }
//_preprocess_page_title(&$variables) {
//  $route_name = \Drupal::routeMatch()->getRouteName();
//  if ($route_name == 'asu_statistics.collection_statistics_view') {
//    $variables['title'] .= " Statistics";
//  }
}