<?php

/**
 * @file
 * Contains self_deposit.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\user\Entity\User;

/**
 * Implements hook_help().
 */
function self_deposit_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the self_deposit module.
    case 'help.page.self_deposit':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('A module to facilitate self deposit') . '</p>';
      return $output;

    default:
  }
}

function self_deposit_preprocess_node(&$variables) {
  if ($variables['node'] && $variables['node']->getType() == 'asu_repository_item') {
    $current_user = User::load(\Drupal::currentUser()->id());
    if ($current_user->hasRole('administrator') || $current_user->hasRole('content_approver') || $current_user->hasRole('metadata_manager')){
      $connection = \Drupal::database();
      $node_id = $variables['node']->id();
      $query = $connection->query("SELECT DISTINCT sid
    FROM webform_submission_data wsd
     WHERE wsd.webform_id = 'self_deposit'
     AND sid IN (SELECT sid FROM webform_submission_data wsd2
                  WHERE wsd2.name = 'item_node'
                    AND wsd2.value = :node_id)", [
        ':node_id' => $node_id
      ]);
      $result = $query->fetchAll();
      if (count($result) > 0) {
        $submission_id = $result[0]->sid;
        $url = "/webform/self_deposit/submissions/" . $submission_id;
        \Drupal::messenger()->addMessage(t('This node is related to a self deposit. <a href="' . $url . '">View original deposit.</a>'));
      }
    }
  }
}
