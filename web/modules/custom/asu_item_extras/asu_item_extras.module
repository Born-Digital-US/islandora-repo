<?php

/**
 * Implements hook_theme().
 */
function asu_item_extras_theme() {
  return [
    'file_video_with_caption' => [
      'template' => 'file-video-caption',
      'variables' => [
        'caption' => NULL,
        'files' => [],
        'poster' => NULL,
        'attributes' => NULL
      ]
    ],
    'file_audio_with_caption' => [
      'template' => 'file-audio-caption',
      'variables' => [
        'caption' => NULL,
        'files' => [],
        'attributes' => NULL
      ]
    ],
  ];
}

function asu_item_extras_get_complex_object_child_nodes($node_id, $howmany = 0) {
  $query = \Drupal::database()->select('node_field_data', 'node_field_data');
  $query->join('node__field_member_of', 'node__field_member_of',
      'node__field_member_of.field_member_of_target_id = node_field_data.nid');
  $query->leftJoin('node__field_weight', 'node__field_weight',
      'node__field_member_of.entity_id = node__field_weight.entity_id AND ' .
      'node__field_weight.deleted = 0 AND ' .
      '(node__field_weight.langcode = node_field_data.langcode AND node__field_weight.bundle = \'asu_repository_item\')');
  $query->join('node__field_title', 'node__field_title',
      'node_field_data.nid = node__field_title.entity_id AND ' .
      'node__field_title.deleted = 0 AND ' .
      '(node__field_title.langcode = node_field_data.langcode OR node__field_title.bundle = \'asu_repository_item\')');
  $query->join('paragraphs_item_field_data', 'paragraphs_item_field_data',
      'node__field_title.field_title_target_revision_id = paragraphs_item_field_data.revision_id');
  $query->join('paragraph__field_main_title', 'paragraph__field_main_title',
      'paragraphs_item_field_data.id = paragraph__field_main_title.entity_id AND ' .
      'paragraph__field_main_title.deleted = 0');
  $query->condition('node_field_data.nid', $node_id);
  $query->condition('node_field_data.status', 1);
  $query->orderBy('node__field_weight.field_weight_value', 'ASC');
  if ($howmany) {
    $query->range(0, $howmany);
  }
  $children = $query
    ->fields('node_field_data')
    ->fields('node__field_member_of')
    ->execute();
  return $children;
}
