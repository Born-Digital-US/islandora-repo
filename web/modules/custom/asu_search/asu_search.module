<?php

use Drupal\search_api\IndexInterface;
use Drupal\views\ViewExecutable;
use Drupal\views\Plugin\views\cache\CachePluginBase;
use Drupal\user\Entity\User;

/**
 * Implements hook_form_alter().
 * @param $form
 * @param FormStateInterface $form_state
 * @param $form_id
 */
function asu_search_form_views_exposed_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id){
  if ($form['#id'] == 'views-exposed-form-solr-search-content-page-3') {
    $current_path = \Drupal::service('path.current')->getPath();
    $node = \Drupal::routeMatch()->getParameter('node');
    // since this block is configured to only display on content type = "Collection"
    // we don't need to check the node's content type.
    $new_search_path = ($node) ? '/collections/' . $node->id() . '/search/' : $current_path;
    $form['#action'] = $new_search_path;
  }
}

/**
 * Implements hook_search_api_solr_field_mapping_alter().
 */
function asu_search_search_api_solr_field_mapping_alter(IndexInterface $index, array &$fields, string $language_id) {
  // Make file size and mime type multi-valued.
  $fields['field_file_size'] = 'itm_field_file_size';
  $fields['field_mime_type'] = 'sm_field_mime_type';
}

function asu_search_preprocess_node(&$variables) {
  if ($variables['node'] && $variables['node']->getType() == 'asu_repository_item') {
    $asu_utils = \Drupal::service('asu_utils');
    $variables['is_published'] = $asu_utils->isNodePublished($variables['node']);
  }
}

/**
 * To potentially suppress the "Matching Collections" block for any /search
 * that has had a facet filter applied to it.
 */
function asu_search_preprocess_views_view(&$variables) {
  if ($variables['id'] == "solr_search_content") {
    // inspect the query from the URL and if there are any facets, suppress
    // the inclusion of the collections block at the top of the /search page.
    $facet_filters = \Drupal::request()->query->get('f');
    if (is_array($facet_filters) && count($facet_filters) > 0) {
      // Since there are multiple header elements, check to be sure that the
      // "view" is in the header... and only get rid of the header element that
      // matches for a theme name of "view_view__solr_search_content__block_1".
      if (
        array_key_exists('view', $variables['header']) && !(array_search('views_view__solr_search_content__block_1', $variables['header']['view']['#theme']) === FALSE)
      ) {
        unset($variables['header']['view']);
      }
    }
  }
}

function asu_search_views_pre_render(ViewExecutable $view) {
  if ($view->id() == 'solr_search_content' && $view->current_display === 'page_1') {
    $results = $view->result;
    $ids = [];
    $user = User::load(\Drupal::currentUser()->id());
    $user_roles = $user->getRoles();
    if (in_array("administrator", $user_roles) || in_array("metadata_manager", $user_roles)){
      foreach ($results as $r) {
        $ids[] = $r->_object->getEntity()->id();
      }
      $content_output = implode(",", $ids);
      $content_output = "<a href='/mods-xml/" . $content_output . "' target='_blank'>Export MODS XML</a>";
      $view->header['area_1']->options['content']['value'] = t($content_output);
    }
    else {
      $view->header['area_1']->options['content']['value'] = "";
    }

  }
}
